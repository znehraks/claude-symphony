# claude-symphony Framework Development

This file contains AI instructions for developers working on the **claude-symphony framework itself**.
If you're working on a **generated project**, refer to `template/CLAUDE.md` instead.

## Project Structure

```
/claude-symphony
├── src/                # TypeScript source code
│   ├── cli/            # CLI implementation
│   └── hooks/          # Hook implementation
├── dist/               # Build output (git-ignored)
├── template/           # End-user project template
├── schemas/            # JSON schemas (for config validation)
├── scripts/            # Development/test scripts
│   ├── dev/            # Development utilities
│   ├── test/           # Test scripts
│   └── user/           # User utilities
└── docs/               # Developer documentation
```

## Build & Test

| Command | Description |
|---------|-------------|
| `pnpm install` | Install dependencies |
| `pnpm run build` | TypeScript compile + schema generation |
| `pnpm run dev` | Watch mode |
| `pnpm run typecheck` | Type check |
| `pnpm run test` | Unit tests |
| `pnpm run test:pipeline` | Pipeline tests |

## Key Files

| File | Role |
|------|------|
| `src/cli/index.ts` | CLI entry point |
| `template/CLAUDE.md` | End-user AI instructions |
| `template/.claude/` | Commands, hooks, skills |
| `schemas/*.json` | Config schemas |
| `tsup.config.ts` | Build configuration |

## Agent Architecture (v0.2.14+)

**Task Tool-based implementation** — Migrated from Agent SDK to Claude Code native Task tool

### Structure

```
src/core/agents/
├── task-spawner.ts   # Task Tool wrapper (~154 lines)
├── registry.ts       # Agent definition loader (168 lines)
├── types.ts          # Type definitions (93 lines)
└── index.ts          # Public exports
```

### Key Changes

| Change | Before (SDK) | After (Task Tool) |
|--------|--------------|-------------------|
| Code size | 266 lines (sdk.ts) | 154 lines (task-spawner.ts) |
| Dependencies | @anthropic-ai/claude-agent-sdk | None (zero dependency) |
| Integration | SDK wrapper | Claude Code native |
| Maintenance | SDK updates required | Evolves with Claude Code |

### Usage Example

```typescript
import { spawnAgent } from '../core/agents/index.js';

const result = await spawnAgent(
  'validation-agent',
  {
    projectRoot: '/path/to/project',
    stage: '01-brainstorm',
    data: { validationRules: {...} },
  },
  'foreground'
);
```

## MCP Server Integration

### Available MCP Servers

| MCP Server | Purpose | Usage |
|-----------|---------|-------|
| **Serena** | Code symbol analysis | Use `find_symbol`, `get_symbols_overview` for code exploration |
| **Context7** | Library documentation | Retrieve external package docs |
| **Playwright** | E2E testing | Browser automation testing |

### Serena Usage Examples

```
# Symbol search
mcp__serena__find_symbol: "CLICommand"

# File symbol overview
mcp__serena__get_symbols_overview: "src/cli/index.ts"

# Find references
mcp__serena__find_referencing_symbols: "initProject"
```

## Contributing

### Branch Strategy

| Branch | Purpose |
|--------|---------|
| `main` | Stable release |
| `feature/*` | New feature development |
| `fix/*` | Bug fixes |
| `docs/*` | Documentation changes |

### PR Rules

1. **Title format**: `type(scope): description`
   - `feat(cli): add new command`
   - `fix(hooks): resolve fallback issue`
   - `docs(readme): update installation guide`

2. **Required checklist**:
   - [ ] `pnpm run build` succeeds
   - [ ] `pnpm run test` passes
   - [ ] `pnpm run typecheck` no errors

3. **Before requesting review**:
   - Update related documentation
   - Add CHANGELOG.md entry (if applicable)

### Code Style

- TypeScript strict mode
- ESLint rules enforced
- JSDoc comments on functions/classes
- Single responsibility per file

### Writing Tests

```typescript
// tests/cli.test.ts
describe('CLI', () => {
  it('should initialize project', async () => {
    // ...
  });
});
```

## Release Process

1. Update `package.json` version
2. Write `CHANGELOG.md`
3. `pnpm run build && pnpm run test`
4. `git commit -m "chore: bump version to x.x.x"`
5. `git tag vx.x.x`
6. `npm publish`

## Important Notes When Modifying

| Area | Caution |
|------|---------|
| `template/` | Copied to end-users — no developer-only content |
| `schemas/` | Run `build:schema` after changes |
| `src/` | Build required after changes (output goes to `dist/`) |
| Config | `$schema` URLs use GitHub raw URLs |

## Prohibited

- Adding developer-only content inside `template/`
- Directly modifying `dist/` (generated by build)
- Committing `node_modules/`
- Using `package-lock.json` (use pnpm)
