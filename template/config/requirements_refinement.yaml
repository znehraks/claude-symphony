# claude-symphony Requirements Refinement Configuration
# 4-level requirement breakdown: Epic → Feature → Task → Subtask

requirements_refinement:
  enabled: true
  description: "Systematic requirements breakdown and refinement loop"
  max_iterations: 5

  # ============================================
  # Granularity Levels (4-Level Hierarchy)
  # ============================================
  granularity_levels:
    - level: "epic"
      order: 1
      name: "Epic"
      description: "Large-scale feature or theme"
      examples:
        - "User Authentication System"
        - "E-commerce Shopping Cart"
        - "Real-time Notifications"
        - "Admin Dashboard"
      characteristics:
        - "Spans multiple sprints"
        - "Contains 3-10 features"
        - "Business-level goal"
      typical_duration: "2-8 weeks"
      max_hours: null  # No limit at epic level

    - level: "feature"
      order: 2
      name: "Feature"
      description: "Individual user-facing capability"
      breakdown_from: "epic"
      examples:
        - "Google OAuth Login"
        - "Product Search with Filters"
        - "Push Notification Delivery"
        - "User Management Table"
      characteristics:
        - "Deliverable in 1 sprint"
        - "Contains 2-5 tasks"
        - "User story level"
      typical_duration: "3-5 days"
      max_hours: 40

    - level: "task"
      order: 3
      name: "Task"
      description: "Technical implementation unit"
      breakdown_from: "feature"
      examples:
        - "Implement OAuth callback handler"
        - "Create search API endpoint"
        - "Build notification service"
        - "Design user table component"
      characteristics:
        - "Single responsibility"
        - "Clear acceptance criteria"
        - "Testable"
      typical_duration: "4-8 hours"
      max_hours: 8

    - level: "subtask"
      order: 4
      name: "Subtask"
      description: "Atomic implementation step"
      breakdown_from: "task"
      examples:
        - "Add Google Client ID to environment"
        - "Write Zod schema for search params"
        - "Configure FCM credentials"
        - "Add pagination controls"
      characteristics:
        - "Single commit scope"
        - "No ambiguity"
        - "Directly actionable"
      typical_duration: "30min - 2 hours"
      max_hours: 2

  # ============================================
  # Auto-Detection Triggers
  # ============================================
  triggers:
    scope_unclear:
      enabled: true
      description: "Detect vague or ambiguous requirements"
      patterns:
        - "should be able to"
        - "might need"
        - "etc."
        - "and more"
        - "various"
        - "TBD"
        - "to be determined"
        - "somehow"
        - "maybe"
      action: "suggest_refinement"
      message: "This requirement seems vague. Consider using /refine to clarify."

    size_large:
      enabled: true
      description: "Detect requirements that are too large"
      condition: "estimated_hours > 40"
      action: "require_breakdown"
      message: "This requirement is too large (>40 hours). Breakdown required."

    missing_acceptance:
      enabled: true
      description: "Detect requirements without clear acceptance criteria"
      patterns:
        - "No acceptance criteria defined"
        - "AC: TBD"
      action: "suggest_refinement"
      message: "Missing acceptance criteria. Consider using /refine to define."

    dependency_unclear:
      enabled: true
      description: "Detect unclear dependencies"
      patterns:
        - "depends on"
        - "after X is done"
        - "when available"
      action: "flag_for_review"
      message: "Dependency detected but not clearly defined."

  # ============================================
  # Refinement Workflow
  # ============================================
  workflow:
    stages:
      - id: "identify"
        name: "Identify"
        description: "Identify requirements needing refinement"
        actions:
          - "scan_for_trigger_patterns"
          - "check_size_thresholds"
          - "flag_candidates"
        outputs:
          - "refinement_candidates.md"

      - id: "analyze"
        name: "Analyze"
        description: "Deep analysis of requirement"
        actions:
          - "determine_current_level"
          - "identify_ambiguities"
          - "map_dependencies"
          - "estimate_effort"
        prompts:
          - "What is the user trying to accomplish?"
          - "What are the edge cases?"
          - "What are the technical constraints?"
          - "What are the acceptance criteria?"

      - id: "breakdown"
        name: "Breakdown"
        description: "Break down into smaller units"
        actions:
          - "apply_granularity_rules"
          - "create_sub_requirements"
          - "assign_estimates"
          - "define_acceptance_criteria"
        rules:
          - "Each level should have 2-5 children"
          - "No task should exceed max_hours"
          - "Each item needs clear acceptance criteria"

      - id: "validate"
        name: "Validate"
        description: "Validate refined requirements"
        checks:
          - "All items have acceptance criteria"
          - "Estimates are within thresholds"
          - "Dependencies are mapped"
          - "No circular dependencies"
          - "INVEST criteria met for tasks"
        actions:
          - "run_validation_checks"
          - "flag_issues"
          - "suggest_fixes"

      - id: "document"
        name: "Document"
        description: "Update documentation with refined requirements"
        actions:
          - "update_requirements_doc"
          - "update_task_list"
          - "record_refinement_history"
        outputs:
          - "refined_requirements.md"
          - "updated tasks.md"

  # ============================================
  # Refinement Templates
  # ============================================
  templates:
    epic_template: |
      ## Epic: {{NAME}}

      ### Description
      {{DESCRIPTION}}

      ### Business Value
      {{BUSINESS_VALUE}}

      ### Features
      {{#each FEATURES}}
      - [ ] {{this.name}}
      {{/each}}

      ### Success Metrics
      {{SUCCESS_METRICS}}

    feature_template: |
      ## Feature: {{NAME}}
      **Parent Epic:** {{EPIC_NAME}}

      ### User Story
      As a {{USER_TYPE}}, I want to {{ACTION}} so that {{BENEFIT}}.

      ### Acceptance Criteria
      {{#each ACCEPTANCE_CRITERIA}}
      - [ ] {{this}}
      {{/each}}

      ### Tasks
      {{#each TASKS}}
      - [ ] {{this.name}} ({{this.estimate}})
      {{/each}}

      ### Estimate
      {{ESTIMATE_HOURS}} hours

    task_template: |
      ## Task: {{NAME}}
      **Parent Feature:** {{FEATURE_NAME}}

      ### Description
      {{DESCRIPTION}}

      ### Acceptance Criteria
      {{#each ACCEPTANCE_CRITERIA}}
      - [ ] {{this}}
      {{/each}}

      ### Subtasks
      {{#each SUBTASKS}}
      - [ ] {{this.name}}
      {{/each}}

      ### Estimate
      {{ESTIMATE_HOURS}} hours

      ### Technical Notes
      {{TECHNICAL_NOTES}}

    subtask_template: |
      - [ ] **{{NAME}}** ({{ESTIMATE}})
        {{DESCRIPTION}}

  # ============================================
  # INVEST Criteria Validation
  # ============================================
  invest_criteria:
    enabled: true
    description: "Validate tasks against INVEST criteria"

    criteria:
      - id: "independent"
        name: "Independent"
        description: "Can be developed without other items"
        check: "dependencies.length == 0 || dependencies_resolved"

      - id: "negotiable"
        name: "Negotiable"
        description: "Details can be discussed"
        check: "has_alternatives || is_flexible"

      - id: "valuable"
        name: "Valuable"
        description: "Delivers value to user"
        check: "has_user_benefit"

      - id: "estimable"
        name: "Estimable"
        description: "Can be estimated"
        check: "estimate_hours > 0"

      - id: "small"
        name: "Small"
        description: "Small enough to complete quickly"
        check: "estimate_hours <= 8"

      - id: "testable"
        name: "Testable"
        description: "Has clear acceptance criteria"
        check: "acceptance_criteria.length > 0"

  # ============================================
  # Commands
  # ============================================
  commands:
    start: "/refine"
    refine_specific: "/refine <requirement>"
    list: "/refine --list"
    validate: "/refine --validate"
    history: "/refine --history"

  # ============================================
  # Integration Points
  # ============================================
  integration:
    stage_01_brainstorm:
      auto_suggest: true
      when: "requirements_captured"
      message: "Use /refine to break down captured requirements"

    stage_03_planning:
      auto_check: true
      before_completion: true
      message: "Validate all requirements are properly refined before proceeding"

    stage_05_task_management:
      auto_apply: true
      description: "Apply refinement hierarchy to task organization"

  # ============================================
  # Output Files
  # ============================================
  outputs:
    refined_requirements:
      location: "stages/03-planning/outputs/refined_requirements.md"
      format: "markdown"

    refinement_log:
      location: "state/refinement_log.json"
      format: "json"

# ============================================
# State Tracking (for progress.json)
# ============================================
#
# "requirements_refinement": {
#   "active": false,
#   "current_iteration": 0,
#   "max_iterations": 5,
#   "requirements_under_refinement": [],
#   "last_refinement_at": null
# },
# "refinement_history": []
