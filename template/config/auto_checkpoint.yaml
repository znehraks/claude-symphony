# claude-symphony Auto-Checkpoint Configuration
# Automatic checkpoint creation and management

auto_checkpoint:
  enabled: true
  description: "자동 체크포인트 생성 및 관리"

  # 트리거 조건
  triggers:
    # 태스크 완료 기반
    task_based:
      enabled: true
      condition: "tasks_completed"
      threshold: 5  # 5개 태스크 완료마다
      action: "create_checkpoint"
      naming: "auto_task_{{count}}_{{timestamp}}"

    # 파일 변경 기반
    file_change_based:
      enabled: true
      condition: "major_file_change"
      threshold: 100  # 100줄 이상 변경
      action: "create_checkpoint"
      naming: "auto_change_{{timestamp}}"

      # 파일 유형별 가중치
      file_weights:
        "*.ts": 1.0
        "*.tsx": 1.0
        "*.js": 1.0
        "*.jsx": 1.0
        "*.py": 1.0
        "*.yaml": 0.5
        "*.json": 0.5
        "*.md": 0.3

    # 파괴적 작업 전
    before_destructive:
      enabled: true
      condition: "destructive_action_detected"
      patterns:
        - "rm -rf"
        - "git reset --hard"
        - "drop table"
        - "DELETE FROM"
        - "truncate"
      action: "force_checkpoint"
      naming: "pre_destructive_{{timestamp}}"
      require_confirmation: true

    # 시간 기반
    time_based:
      enabled: true
      condition: "interval"
      interval_minutes: 30
      action: "create_checkpoint"
      naming: "auto_interval_{{timestamp}}"
      only_if_changes: true  # 변경이 있을 때만

    # 스테이지 기반
    stage_based:
      enabled: true
      conditions:
        on_stage_start: false
        on_stage_complete: true
        on_stage_error: true
      action: "create_checkpoint"
      naming: "stage_{{stage_id}}_{{status}}_{{timestamp}}"

  # 보존 정책
  retention:
    max_checkpoints: 20
    max_age_days: 30

    cleanup_strategy: "keep_milestones"

    milestone_criteria:
      - stage_complete
      - pre_destructive
      - user_created
      - tagged

    # 자동 정리
    auto_cleanup:
      enabled: true
      schedule: "daily"
      preserve_minimum: 5

  # 체크포인트 내용
  checkpoint_content:
    include:
      - source_code: true
      - config_files: true
      - state_files: true
      - handoffs: true
      - outputs: true

    exclude:
      - "node_modules/"
      - ".git/"
      - "*.log"
      - "*.tmp"
      - "__pycache__/"
      - ".cache/"

    # 메타데이터
    metadata:
      - timestamp
      - stage_id
      - task_count
      - trigger_reason
      - file_changes_summary
      - git_commit_hash

  # 스토리지 설정
  storage:
    base_path: "state/checkpoints/"
    format: "tar.gz"  # tar.gz, zip, directory
    compression_level: 6  # 1-9

    naming_convention: "{{stage}}_{{trigger}}_{{timestamp}}"

    # 외부 스토리지 백업 (옵션)
    external_backup:
      enabled: false
      provider: null  # s3, gcs, azure
      path: null

# 체크포인트 생성 프로세스
creation_process:
  steps:
    - name: "validate_state"
      description: "현재 상태 유효성 검증"
      required: true

    - name: "collect_files"
      description: "포함할 파일 수집"
      required: true

    - name: "generate_metadata"
      description: "메타데이터 생성"
      required: true

    - name: "create_archive"
      description: "아카이브 생성"
      required: true

    - name: "verify_integrity"
      description: "무결성 검증"
      required: true

    - name: "cleanup_old"
      description: "오래된 체크포인트 정리"
      required: false

  # 실패 처리
  on_failure:
    retry: 2
    fallback: "skip_with_warning"
    notify: true

# 알림 설정
notifications:
  on_create:
    enabled: true
    message: "체크포인트 생성됨: {{name}}"

  on_cleanup:
    enabled: true
    message: "오래된 체크포인트 정리됨: {{count}}개"

  on_threshold:
    enabled: true
    threshold: 15  # 15개 초과 시
    message: "체크포인트가 {{count}}개입니다. 정리가 필요할 수 있습니다."

# Git 통합
git_integration:
  tag_checkpoints: true
  tag_prefix: "checkpoint/"

  commit_message_template: |
    chore(checkpoint): Auto-checkpoint {{trigger}}

    Stage: {{stage_id}}
    Trigger: {{trigger_reason}}
    Files: {{file_count}}

  push_tags: false  # true면 원격에 태그 푸시
