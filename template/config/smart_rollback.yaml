# claude-symphony Smart Rollback Configuration
# Intelligent rollback suggestions and execution

smart_rollback:
  enabled: true
  description: "지능형 롤백 제안 및 실행"

  # 에러 발생 시 롤백 제안
  suggestion:
    on_error:
      enabled: true
      steps:
        - analyze_error_type
        - find_relevant_checkpoint
        - calculate_rollback_scope
        - suggest_recovery_path

    analysis:
      error_patterns:
        build_failure:
          description: "빌드 실패"
          common_causes: ["dependency", "syntax", "type_error"]
          suggested_scope: "file_level"

        test_failure:
          description: "테스트 실패"
          common_causes: ["logic_error", "state_change"]
          suggested_scope: "function_level"

        runtime_error:
          description: "런타임 에러"
          common_causes: ["null_reference", "type_mismatch"]
          suggested_scope: "file_level"

        configuration_error:
          description: "설정 에러"
          common_causes: ["invalid_config", "missing_env"]
          suggested_scope: "config_only"

    checkpoint_selection:
      strategy: "most_recent_stable"
      fallback: "last_stage_complete"

      scoring:
        recency: 0.4
        stability: 0.4
        relevance: 0.2

  # 부분 롤백
  partial_rollback:
    enabled: true
    description: "전체 롤백 대신 영향 범위만 선택적 복구"

    granularity:
      file_level:
        description: "특정 파일만 롤백"
        use_when: ["single_file_error", "isolated_change"]

      function_level:
        description: "특정 함수/메서드만 롤백"
        use_when: ["logic_error", "refactoring_issue"]
        supported_languages: ["typescript", "javascript", "python"]

      stage_level:
        description: "특정 스테이지 전체 롤백"
        use_when: ["major_failure", "architecture_change"]

      config_only:
        description: "설정 파일만 롤백"
        use_when: ["configuration_error"]
        patterns: ["*.yaml", "*.json", "*.env*"]

    # 의존성 분석
    dependency_analysis:
      enabled: true
      description: "롤백 시 영향받는 파일 자동 감지"

      include_dependents: true
      max_cascade_depth: 3

  # 롤백 미리보기
  rollback_preview:
    enabled: true
    description: "롤백 전 변경사항 미리보기"

    show_diff: true
    show_impact: true
    show_affected_files: true
    show_test_status: true

    require_confirmation: true
    confirmation_prompt: |
      ## 롤백 미리보기

      **대상 체크포인트**: {{checkpoint_name}}
      **롤백 범위**: {{scope}}

      ### 영향받는 파일 ({{file_count}}개)
      {{affected_files}}

      ### 변경사항 요약
      {{diff_summary}}

      이 롤백을 실행하시겠습니까? (y/n)

  # 롤백 실행
  execution:
    pre_rollback:
      - create_backup_checkpoint
      - save_current_state
      - notify_rollback_start

    rollback_steps:
      - validate_checkpoint
      - extract_files
      - apply_changes
      - verify_integrity
      - update_state

    post_rollback:
      - run_validation
      - update_handoff
      - notify_completion

    # 실패 처리
    on_failure:
      strategy: "restore_backup"
      notify: true
      log_details: true

  # 안전 장치
  safety:
    # 롤백 불가 조건
    prevent_rollback_when:
      - uncommitted_changes: true
      - active_processes: true
      - locked_files: true

    # 확인 필요 조건
    require_confirmation_when:
      - scope: "stage_level"
      - files_affected: 10
      - includes_production: true

    # 롤백 제한
    limits:
      max_rollback_stages: 2
      max_file_rollbacks: 50
      cooldown_minutes: 5

# 롤백 히스토리
history:
  enabled: true
  storage_path: "state/rollback_history/"

  track:
    - timestamp
    - trigger
    - scope
    - affected_files
    - success_status
    - recovery_time

  retention_days: 30

# 복구 가이드
recovery_guide:
  enabled: true
  description: "롤백 후 복구 작업 안내"

  templates:
    after_file_rollback: |
      ## 파일 롤백 완료

      다음 파일이 복구되었습니다:
      {{files}}

      ### 권장 다음 단계
      1. 변경사항 확인: `git diff`
      2. 테스트 실행: `npm test`
      3. 필요시 수정 후 재커밋

    after_stage_rollback: |
      ## 스테이지 롤백 완료

      {{stage_id}}가 체크포인트로 복구되었습니다.

      ### 복구 정보
      - 체크포인트: {{checkpoint_name}}
      - 복구된 파일: {{file_count}}개

      ### 권장 다음 단계
      1. HANDOFF 확인: `stages/{{stage_id}}/HANDOFF.md`
      2. 태스크 재검토
      3. 스테이지 재시작

# 통합 설정
integration:
  git:
    auto_stash: true
    create_branch: false  # true면 롤백용 브랜치 생성

  handoff:
    update_on_rollback: true
    include_rollback_info: true

  memory:
    save_rollback_decision: true
    observation_type: "bugfix"
