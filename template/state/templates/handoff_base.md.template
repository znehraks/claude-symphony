# Stage Handoff: {{CURRENT_STAGE}} → {{NEXT_STAGE}}

**Created**: {{TIMESTAMP}}
**Creator**: {{PRIMARY_AI}}
**Duration**: {{DURATION}}

---

## AI Usage Log

> This section compares intended AI settings with actual usage to track collaboration efficiency.

### Intended vs Actual Comparison

| Item | Intended | Actual | Match |
|------|----------|--------|-------|
| Primary AI | {{INTENDED_PRIMARY_AI}} | {{ACTUAL_PRIMARY_AI}} | {{PRIMARY_MATCH}} |
| Secondary AI | {{INTENDED_SECONDARY_AI}} | {{ACTUAL_SECONDARY_AI}} | {{SECONDARY_MATCH}} |
| Collaboration Mode | {{INTENDED_COLLABORATION_MODE}} | {{ACTUAL_COLLABORATION_MODE}} | {{MODE_MATCH}} |
| External AI Call | {{INTENDED_EXTERNAL_CALL}} | {{ACTUAL_EXTERNAL_CALL}} | {{EXTERNAL_MATCH}} |

### Collaboration Mode Details

- **Configured Mode**: {{COLLABORATION_MODE}} (parallel/debate/sequential/none)
- **Actual Execution**: {{MODE_EXECUTED}} (Yes/No)
- **Reason for Non-Execution**: {{NON_EXECUTION_REASON}}

### AI Call Log

| AI | Call Time | Role | Prompt | Result | Status |
|----|-----------|------|--------|--------|--------|
{{#each AI_CALLS}}
| {{this.model}} | {{this.timestamp}} | {{this.role}} | {{this.prompt_file}} | {{this.output_file}} | {{this.status}} |
{{/each}}

### Fallback Log

| Attempted AI | Failure Time | Error | Fallback AI | Result |
|--------------|--------------|-------|-------------|--------|
{{#each FALLBACK_EVENTS}}
| {{this.attempted_model}} | {{this.failure_time}} | {{this.error}} | {{this.fallback_model}} | {{this.result}} |
{{/each}}

> Configuration: `config/ai_collaboration.yaml`, `config/mcp_fallbacks.yaml`

---

## Completed Tasks

{{#each COMPLETED_TASKS}}
- [x] {{this.name}} {{#if this.ai}}({{this.ai}}){{/if}}
{{/each}}

---

## Context for Next Agent

### Key Decisions

{{#each KEY_DECISIONS}}
- **{{this.topic}}**: {{this.decision}}
  - Rationale: {{this.rationale}}
  - Alternatives: {{this.alternatives}}
{{/each}}

### Modified Files

| File | Change Type | Lines Changed | Responsible AI |
|------|-------------|---------------|----------------|
{{#each MODIFIED_FILES}}
| `{{this.path}}` | {{this.change_type}} | {{this.lines_changed}} | {{this.ai_model}} |
{{/each}}

### Known Issues / Technical Debt

{{#each KNOWN_ISSUES}}
- **{{this.id}}**: {{this.description}}
  - Severity: {{this.severity}}
  - Status: {{this.status}}
{{/each}}

---

## Test Status (Test-First Flow)

> ⚠️ Verify that tests were run in this stage.

### Tests Run

| Test Type | Run Time | Result | Coverage |
|-----------|----------|--------|----------|
{{#each TESTS_RUN}}
| {{this.type}} | {{this.timestamp}} | {{this.result}} | {{this.coverage}} |
{{/each}}

### Smoke Test Results

- **`npm run dev` execution**: {{DEV_SERVER_STATUS}}
- **Basic functionality check**: {{BASIC_FUNCTIONALITY}}
- **Playwright smoke test**: {{PLAYWRIGHT_SMOKE}}

### Bugs Found

{{#each BUGS_FOUND}}
- **{{this.id}}**: {{this.description}}
  - Found at: {{this.found_at}}
  - Status: {{this.status}}
  - Fix file: {{this.fix_file}}
{{/each}}

---

## Checkpoint Information

| ID | Created | Description | Auto/Manual |
|----|---------|-------------|-------------|
{{#each CHECKPOINTS}}
| {{this.id}} | {{this.date}} | {{this.description}} | {{this.type}} |
{{/each}}

Recovery command:
```bash
scripts/restore-checkpoint.sh {{LATEST_CP_ID}}
```

---

## Generated Outputs

| File | Description | Validation Status |
|------|-------------|-------------------|
{{#each OUTPUTS}}
| {{this.path}} | {{this.description}} | {{this.validation_status}} |
{{/each}}

---

## {{NEXT_STAGE}} Stage Guide

### Immediate Tasks

{{#each IMMEDIATE_TASKS}}
{{this.order}}. {{this.task}}
{{/each}}

### Warnings

{{#each WARNINGS}}
- ⚠️ {{this}}
{{/each}}

### Reference Files

{{#each REFERENCE_FILES}}
- `{{this}}`
{{/each}}

---

## Metadata

```yaml
stage: "{{CURRENT_STAGE}}"
status: "completed"
next_stage: "{{NEXT_STAGE}}"
timestamp: "{{TIMESTAMP}}"

ai_usage:
  intended:
    primary: "{{INTENDED_PRIMARY_AI}}"
    secondary: "{{INTENDED_SECONDARY_AI}}"
    collaboration_mode: "{{INTENDED_COLLABORATION_MODE}}"
  actual:
    primary: "{{ACTUAL_PRIMARY_AI}}"
    secondary: "{{ACTUAL_SECONDARY_AI}}"
    collaboration_mode: "{{ACTUAL_COLLABORATION_MODE}}"
  fallbacks: {{FALLBACK_COUNT}}
  match_rate: "{{MATCH_RATE}}"

testing:
  smoke_test_run: {{SMOKE_TEST_RUN}}
  bugs_found: {{BUGS_FOUND_COUNT}}
  bugs_fixed: {{BUGS_FIXED_COUNT}}

checkpoint_id: "{{LATEST_CP_ID}}"
files_modified: {{FILE_COUNT}}
```
